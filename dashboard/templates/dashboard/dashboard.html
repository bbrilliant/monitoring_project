{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Health Check</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'dashboard/css/bootstrap.min.css' %}">
    <script src="{% static 'dashboard/js/chart.umd.min.js' %}"></script>
</head>
<body class="bg-light">

<div class="container py-5">
    <h1 class="mb-3 text-center">Dashboard - Monitoring APIs</h1>

    <!-- Compteur de dernière mise à jour -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <p id="lastUpdate" class="text-muted fst-italic m-0">
            Dernière mise à jour : en attente...
        </p>
        <button class="btn btn-primary btn-sm" onclick="loadData()">Rafraîchir maintenant</button>
    </div>

    <!-- Tableau des APIs -->
    <table id="apiTable" class="table table-bordered table-striped shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>Service</th>
                <th>URL</th>
                <th>Statut API</th>
                <th>Statut Stockage</th>
                <th>Total (Go)</th>
                <th>Libre (Go)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Graphique -->
    <div class="card mt-5 shadow-sm">
        <div class="card-body">
            <h5 class="card-title text-center">Comparaison Espace Disque</h5>
            <canvas id="diskChart" height="120"></canvas>
        </div>
    </div>
</div>

<script>
    let chart;

    // Fonction utilitaire pour l'heure
    function getFormattedTime() {
        const now = new Date();
        return now.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
    }

    async function loadData() {
        const response = await fetch("/api/data/");
        const apis = await response.json();

        // --- Mise à jour du tableau ---
        const tbody = document.querySelector("#apiTable tbody");
        tbody.innerHTML = "";
        apis.forEach(api => {
            tbody.innerHTML += `
                <tr>
                    <td><strong>${api.name}</strong></td>
                    <td><a href="${api.url}" target="_blank">${api.url}</a></td>
                    <td>${api.status === "UP" ? '<span class="badge bg-success">UP</span>' :
                         api.status === "DOWN" ? '<span class="badge bg-danger">DOWN</span>' :
                         '<span class="badge bg-warning text-dark">'+api.status+'</span>'}</td>
                    <td>${api.disk_status === "UP" ? '<span class="badge bg-success">OK</span>' :
                         api.disk_status === "N/A" ? '<span class="badge bg-secondary">N/A</span>' :
                         '<span class="badge bg-danger">Issue</span>'}</td>
                    <td>${(api.disk_total / (1024**3)).toFixed(2)}</td>
                    <td>${(api.disk_free / (1024**3)).toFixed(2)}</td>
                </tr>`;
        });

        // --- Mise à jour du graphique ---
        const labels = apis.map(api => api.name);
        const free = apis.map(api => (api.disk_free / (1024**3)).toFixed(2));
        const used = apis.map(api => ((api.disk_total - api.disk_free) / (1024**3)).toFixed(2));

        if (chart) {
            chart.destroy();
        }

        const ctx = document.getElementById("diskChart").getContext("2d");
        chart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: labels,
                datasets: [
                    { label: "Utilisé (Go)", data: used, backgroundColor: "#dc3545" },
                    { label: "Libre (Go)", data: free, backgroundColor: "#28a745" }
                ]
            },
            options: { responsive: true }
        });

        // --- Mettre à jour le compteur ---
        document.getElementById("lastUpdate").innerText =
            "Dernière mise à jour : " + getFormattedTime();
    }

    // Charger au démarrage
    loadData();

    // Rafraîchir toutes les 5 minutes (300 000 ms)
    setInterval(loadData, 300000);
</script>

<script src="{% static 'dashboard/js/bootstrap.bundle.min.js' %}"></script>
</body>
</html>
