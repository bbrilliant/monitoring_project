 {% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Monitoring APIs - Vue Globale</title>
    <link href="{% static 'dashboard/css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'dashboard/css/style.css' %}" rel="stylesheet">
</head>
<body class="bg-light">

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container container-fluid">
    <a class="navbar-brand" href="/">API MONITORING DASHBOARD</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <!-- Admin -->
        <li class="nav-item">
          <button class="btn btn-success btn-sm"><a class="nav-link active" href="/admin/">Admin</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- CONTENU PRINCIPAL -->
<div class="container py-2">
   <div class="row">
  <div class="col-sm-6 mb-3 mb-sm-0">
    <div class="card   text-bg-light mb-3">
      <div class="card-body">
        <h5 class="card-title">API - STATISTICS</h5>
          <div class="card text-center shadow-sm m-2">
            <div class="card-body">
              <h5 class="card-title">TOTAL APIs</h5>
              <p class="display-6" style="font-weight: bold">{{ stats.total }}</p>
            </div>
          </div>
          <div class="card text-center shadow-sm text-bg-success m-2">
                <div class="card-body">
                    <h5 class="card-title text-success">UP</h5>
                    <p class="display-6 text-success" style="font-weight: bold">{{ stats.up }}</p>
                </div>
          </div>
          <div class="card text-center shadow-sm text-bg-danger m-2">
            <div class="card-body">
              <h5 class="card-title text-danger">DOWN</h5>
              <p class="display-6 text-danger" style="font-weight: bold">{{ stats.down }}</p>
            </div>
          </div>
      </div>
    </div>
  </div>
  <div class="col-sm-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title text-danger">APIs DOWN</h5>
        {% if down_apis %}
            <ul class="list-group">
                {% for api in down_apis %}
                    <li class="list-group-item list-group-item-danger">{{ api }}</li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-success">✅ Toutes les APIs sont UP !</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
    
</div>

<script>
    let chart;

    // Fonction utilitaire pour l'heure
    function getFormattedTime() {
        const now = new Date();
        return now.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
    }

    async function loadData() {
        const response = await fetch("/api/data/");
        const apis = await response.json();

        // --- Mise à jour du tableau ---
        const tbody = document.querySelector("#apiTable tbody");
        tbody.innerHTML = "";
        apis.forEach(api => {
            tbody.innerHTML += `
                <tr>
                    <td><strong>${api.name}</strong></td>
                    <td><a href="${api.url}" target="_blank">${api.url}</a></td>
                    <td>${api.status === "UP" ? '<span class="badge bg-success">UP</span>' :
                         api.status === "DOWN" ? '<span class="badge bg-danger">DOWN</span>' :
                         '<span class="badge bg-warning text-dark">'+api.status+'</span>'}</td>
                    <td>${api.disk_status === "UP" ? '<span class="badge bg-success">OK</span>' :
                         api.disk_status === "N/A" ? '<span class="badge bg-secondary">N/A</span>' :
                         '<span class="badge bg-danger">Issue</span>'}</td>
                    <td>${(api.disk_total / (1024**3)).toFixed(2)}</td>
                    <td>${(api.disk_free / (1024**3)).toFixed(2)}</td>
                </tr>`;
        });

        // --- Mise à jour du graphique ---
        const labels = apis.map(api => api.name);
        const free = apis.map(api => (api.disk_free / (1024**3)).toFixed(2));
        const used = apis.map(api => ((api.disk_total - api.disk_free) / (1024**3)).toFixed(2));

        if (chart) {
            chart.destroy();
        }

        const ctx = document.getElementById("diskChart").getContext("2d");
        chart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: labels,
                datasets: [
                    { label: "Utilisé (Go)", data: used, backgroundColor: "#dc3545" },
                    { label: "Libre (Go)", data: free, backgroundColor: "#28a745" }
                ]
            },
            options: { responsive: true }
        });

        // --- Mettre à jour le compteur ---
        document.getElementById("lastUpdate").innerText =
            "Dernière mise à jour : " + getFormattedTime();
    }

    // Charger au démarrage
    loadData();

    // Rafraîchir toutes les 5 minutes (300 000 ms)
    setInterval(loadData, 300000);
</script>

<!-- JS -->
<script src="{% static 'dashboard/js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'dashboard/js/chart.umd.min.js' %}"></script>
</body>
</html>
